-- SQL statements for Supabase table creation and RLS policies

-- ====================================================================================================
-- PROFILES TABLE
-- ====================================================================================================

-- CREATE THE PROFILES TABLE
CREATE TABLE public.profiles (
  ID UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  USERNAME TEXT UNIQUE,
  AVATAR_URL TEXT,
  UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  PRIMARY KEY (ID)
);

-- ENABLE RLS ON THE PROFILES TABLE
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- POLICY: ALLOW AUTHENTICATED USERS TO SELECT ALL PROFILES (ADJUST AS NEEDED)
CREATE POLICY "PUBLIC PROFILES ARE VIEWABLE BY AUTHENTICATED USERS."
  ON public.profiles
  FOR SELECT
  TO AUTHENTICATED
  USING (
    TRUE
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO INSERT THEIR OWN PROFILE
CREATE POLICY "USERS CAN INSERT THEIR OWN PROFILE."
  ON public.profiles
  FOR INSERT
  TO AUTHENTICATED
  WITH CHECK (
    auth.uid() = ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO UPDATE THEIR OWN PROFILE
CREATE POLICY "USERS CAN UPDATE THEIR OWN PROFILE."
  ON public.profiles
  FOR UPDATE
  TO AUTHENTICATED
  USING (
    auth.uid() = ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO DELETE THEIR OWN PROFILE
CREATE POLICY "USERS CAN DELETE THEIR OWN PROFILE."
  ON public.profiles
  FOR DELETE
  TO AUTHENTICATED
  USING (
    auth.uid() = ID
  );

-- FUNCTION: HANDLE NEW USER PROFILE CREATION
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (ID, USERNAME)
  VALUES (NEW.ID, NEW.EMAIL);
  RETURN NEW;
END;
$$ LANGUAGE PLPGSQL SECURITY DEFINER;

-- TRIGGER: ON AUTH USER CREATED
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- ====================================================================================================
-- ACTIVITIES TABLE
-- ====================================================================================================

-- CREATE THE ACTIVITIES TABLE
CREATE TABLE public.activities (
  ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  TITLE TEXT NOT NULL,
  CATEGORY TEXT,
  TIME TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  AMOUNT NUMERIC NOT NULL,
  ICON TEXT,
  SOURCE_ASSET_ID BIGINT,
  CURRENCY TEXT NOT NULL,
  CONSTRAINT FK_USER FOREIGN KEY (USER_ID) REFERENCES auth.users(id) ON DELETE CASCADE
);

-- ENABLE RLS ON THE ACTIVITIES TABLE
ALTER TABLE public.activities ENABLE ROW LEVEL SECURITY;

-- POLICY: ALLOW AUTHENTICATED USERS TO SELECT THEIR OWN ACTIVITIES
CREATE POLICY "USERS CAN VIEW THEIR OWN ACTIVITIES."
  ON public.activities
  FOR SELECT
  TO AUTHENTICATED
  USING (
    auth.uid() = USER_ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO INSERT THEIR OWN ACTIVITIES
CREATE POLICY "USERS CAN INSERT THEIR OWN ACTIVITIES."
  ON public.activities
  FOR INSERT
  TO AUTHENTICATED
  WITH CHECK (
    auth.uid() = USER_ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO UPDATE THEIR OWN ACTIVITIES
CREATE POLICY "USERS CAN UPDATE THEIR OWN ACTIVITIES."
  ON public.activities
  FOR UPDATE
  TO AUTHENTICATED
  USING (
    auth.uid() = USER_ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO DELETE THEIR OWN ACTIVITIES
CREATE POLICY "USERS CAN DELETE THEIR OWN ACTIVITIES."
  ON public.activities
  FOR DELETE
  TO AUTHENTICATED
  USING (
    auth.uid() = USER_ID
  );

-- ====================================================================================================
-- ASSET_ITEMS TABLE
-- ====================================================================================================

-- CREATE THE ASSET_ITEMS TABLE
CREATE TABLE public.asset_items (
  ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  USER_ID UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  ASSET_KEY TEXT NOT NULL,
  NAME TEXT NOT NULL,
  INSTITUTION TEXT,
  AMOUNT NUMERIC NOT NULL,
  CURRENCY TEXT NOT NULL,
  DATE DATE DEFAULT NOW(),
  REMARKS TEXT,
  ATTRIBUTES JSONB,
  CONSTRAINT FK_USER_ASSETS FOREIGN KEY (USER_ID) REFERENCES auth.users(id) ON DELETE CASCADE
);

-- ENABLE RLS ON THE ASSET_ITEMS TABLE
ALTER TABLE public.asset_items ENABLE ROW LEVEL SECURITY;

-- POLICY: ALLOW AUTHENTICATED USERS TO SELECT THEIR OWN ASSET ITEMS
CREATE POLICY "USERS CAN VIEW THEIR OWN ASSET ITEMS."
  ON public.asset_items
  FOR SELECT
  TO AUTHENTICATED
  USING (
    auth.uid() = USER_ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO INSERT THEIR OWN ASSET ITEMS
CREATE POLICY "USERS CAN INSERT THEIR OWN ASSET ITEMS."
  ON public.asset_items
  FOR INSERT
  TO AUTHENTICATED
  WITH CHECK (
    auth.uid() = USER_ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO UPDATE THEIR OWN ASSET ITEMS
CREATE POLICY "USERS CAN UPDATE THEIR OWN ASSET ITEMS."
  ON public.asset_items
  FOR UPDATE
  TO AUTHENTICATED
  USING (
    auth.uid() = USER_ID
  );

-- POLICY: ALLOW AUTHENTICATED USERS TO DELETE THEIR OWN ASSET ITEMS
CREATE POLICY "USERS CAN DELETE THEIR OWN ASSET ITEMS."
  ON public.asset_items
  FOR DELETE
  TO AUTHENTICATED
  USING (
    auth.uid() = USER_ID
  );